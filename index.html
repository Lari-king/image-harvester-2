<!DOCTYPE html>
<html lang="fr" class="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Image Harvester</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <div id="root" class="flex-1"></div>

    <script type="module">
      // -------------------------------
      // Choix de l’API dynamique
      // -------------------------------
      const API = (() => {
        const u = new URL(location.href);
        const param = u.searchParams.get("api");
        if (param) return param; // priorité au ?api=...
        // Fallback (met ici un Codespace par défaut si tu veux éviter de taper ?api= à chaque fois)
        return "https://turbo-space-barnacle-5g5wgxv76qgq2p7vv-3001.app.github.dev/";
      })();

      const e = React.createElement;

      function App() {
        const [urls, setUrls] = React.useState("");
        const [logs, setLogs] = React.useState([]);
        const [images, setImages] = React.useState([]);

        const startAnalysis = async () => {
          setLogs([]);
          setImages([]);
          try {
            const res = await fetch(`${API}/api/jobs`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ urls: urls.split("\n").map(u => u.trim()).filter(Boolean) })
            });
            if (!res.ok) throw new Error("Erreur job");
            const { jobId } = await res.json();
            setLogs(l => [...l, "Job lancé: " + jobId]);

            // Connexion SSE pour suivre la progression
            const es = new EventSource(`${API}/api/run/${jobId}`);
            es.onmessage = ev => {
              try {
                const data = JSON.parse(ev.data);
                if (data.type === "log") {
                  setLogs(l => [...l, data.message]);
                } else if (data.type === "done") {
                  setLogs(l => [...l, "Analyse terminée ✅"]);
                  setImages(data.results || []);
                  es.close();
                }
              } catch (err) {
                console.error(err);
              }
            };
          } catch (err) {
            setLogs(l => [...l, "Erreur: " + err.message]);
          }
        };

        return e("div", { className: "p-6 space-y-4 max-w-3xl mx-auto" }, [
          e("h1", { className: "text-2xl font-bold" }, "Image Harvester"),
          e("p", {}, "Backend API: " + API),
          e("textarea", {
            value: urls,
            onChange: ev => setUrls(ev.target.value),
            className: "w-full p-2 rounded bg-gray-800 border border-gray-700",
            placeholder: "Collez 1 URL par ligne (ex: https://zara.com …)"
          }),
          e("button", {
            className: "px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded",
            onClick: startAnalysis
          }, "Lancer l’analyse"),
          e("div", { className: "bg-black/40 p-2 rounded max-h-48 overflow-auto text-sm" },
            logs.map((l, i) => e("div", { key: i }, l))
          ),
          e("div", { className: "grid grid-cols-2 md:grid-cols-4 gap-2" },
            images.map((src, i) =>
              e("img", { key: i, src, className: "rounded shadow" })
            )
          )
        ]);
      }

      ReactDOM.createRoot(document.getElementById("root")).render(e(App));
    </script>
  </body>
</html>
